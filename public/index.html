<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶Ü Task Duck v4 ‚Äî Stay in Scope</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1117;--surface:#1a1d27;--surface2:#222633;--border:#2a2e3b;--yellow:#f5c542;--yellow-dim:#f5c54233;--yellow-glow:#f5c54266;--red:#e85d5d;--red-dim:#e85d5d22;--green:#4ecb71;--green-dim:#4ecb7122;--blue:#5b9cf5;--blue-dim:#5b9cf522;--orange:#e8943d;--orange-dim:#e8943d22;--purple:#a78bfa;--purple-dim:#a78bfa22;--text:#e8e6e1;--text-dim:#8b8a87;--text-muted:#5a5957;--mono:'DM Mono',monospace;--sans:'Outfit',sans-serif}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);background-size:60px 60px;opacity:.15;z-index:-1}
.app{max-width:860px;margin:0 auto;padding:2rem 1.5rem 4rem}
.login-overlay{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;transition:opacity .4s}
.login-overlay.hidden{opacity:0;pointer-events:none}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:2.5rem 2rem;text-align:center;max-width:360px;width:90%}
.login-box .login-duck{font-size:3.5rem;margin-bottom:.5rem}
.login-box h2{font-size:1.3rem;font-weight:700;margin-bottom:.3rem}
.login-box .login-sub{color:var(--text-dim);font-size:.85rem;margin-bottom:1.5rem}
.login-box input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:.75rem 2.5rem .75rem 1rem;color:var(--text);font-family:var(--sans);font-size:.9rem;text-align:center;outline:none;margin-bottom:.75rem}
.login-box input:focus{border-color:var(--yellow);box-shadow:0 0 0 3px var(--yellow-dim)}
.login-box .pw-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-muted);cursor:pointer;padding:4px;display:flex;align-items:center}
.login-box .pw-toggle:hover{color:var(--text)}
.login-box .login-error{color:var(--red);font-size:.8rem;margin-bottom:.5rem;min-height:1.2rem}
.login-lockout{background:var(--red-dim);border:1px solid var(--red);border-radius:8px;padding:.6rem .8rem;margin-bottom:.75rem;font-family:var(--mono);font-size:.75rem;color:var(--red);text-align:center;display:none}
.login-attempts{font-family:var(--mono);font-size:.68rem;color:var(--text-muted);text-align:center;margin-top:.5rem;display:none}
.header{text-align:center;margin-bottom:2rem;animation:fadeDown .6s ease}
.header h1{font-size:2.2rem;font-weight:800;letter-spacing:-.03em;margin-bottom:.2rem}
.header h1 span.y{color:var(--yellow)}.header h1 span.v{font-size:.5em;color:var(--text-muted)}
.header p{color:var(--text-dim);font-size:.9rem;font-weight:300}
.header .shortcuts-hint{font-family:var(--mono);font-size:.65rem;color:var(--text-muted);margin-top:.4rem}
.header .shortcuts-hint kbd{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-family:var(--mono);font-size:.6rem}
.duck-zone{display:flex;align-items:flex-start;gap:1.25rem;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:1.25rem;margin-bottom:2rem;animation:fadeUp .5s ease .1s both;position:relative;overflow:hidden}
.duck-zone::after{content:'';position:absolute;top:-50%;right:-30%;width:300px;height:300px;background:radial-gradient(circle,var(--yellow-dim) 0%,transparent 70%);pointer-events:none}
.duck-avatar{flex-shrink:0;width:72px;height:72px;background:var(--yellow-dim);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2.4rem;cursor:pointer;transition:transform .3s,box-shadow .3s;position:relative;z-index:1;user-select:none}
.duck-avatar:hover{transform:scale(1.1) rotate(-5deg);box-shadow:0 0 20px var(--yellow-glow)}
.duck-avatar.quack{animation:quack .4s ease}
.duck-speech{flex:1;position:relative;z-index:1}
.duck-speech .label{font-family:var(--mono);font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;color:var(--yellow);margin-bottom:.35rem}
.duck-speech p{font-size:.95rem;line-height:1.55}
.sound-toggle,.history-toggle{position:fixed;top:1rem;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:.4rem .7rem;color:var(--text-dim);cursor:pointer;z-index:50;transition:all .2s;display:flex;align-items:center;gap:.35rem;user-select:none;font-family:var(--mono);font-size:.65rem}
.sound-toggle{left:1rem}.history-toggle{right:1rem}
.sound-toggle:hover,.history-toggle:hover{border-color:var(--yellow);color:var(--yellow)}
.autosave-indicator{position:fixed;bottom:1rem;left:1rem;font-family:var(--mono);font-size:.6rem;color:var(--text-muted);z-index:50;opacity:0;transition:opacity .3s}
.autosave-indicator.show{opacity:1}
.step{animation:fadeUp .5s ease both}
.step-header{display:flex;align-items:center;gap:.75rem;padding:.85rem 0;cursor:pointer;user-select:none}
.step-number{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:.8rem;font-weight:500;border:2px solid var(--border);color:var(--text-dim);flex-shrink:0;transition:all .3s}
.step.active .step-number{border-color:var(--yellow);color:var(--yellow);box-shadow:0 0 12px var(--yellow-dim)}
.step.completed .step-number{border-color:var(--green);background:var(--green);color:var(--bg)}
.step.completed .step-number::after{content:'‚úì'}.step.completed .step-number span{display:none}
.step-title{font-size:1rem;font-weight:600}
.step-tag{font-family:var(--mono);font-size:.6rem;text-transform:uppercase;letter-spacing:.08em;padding:.15rem .45rem;border-radius:4px;margin-left:auto;flex-shrink:0}
.step-body{max-height:0;overflow:hidden;transition:max-height .4s ease,opacity .3s;opacity:0;padding-left:3rem}
.step.active .step-body,.step.reopened .step-body{max-height:5000px;opacity:1}
.step-connector{width:2px;height:16px;background:var(--border);margin-left:16px;transition:background .3s}
.step.completed+.step-connector{background:var(--green)}
.field{margin-bottom:.85rem}
.field label{display:block;font-family:var(--mono);font-size:.68rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text-dim);margin-bottom:.35rem}
.field textarea,.field input[type="text"],.field input[type="number"]{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:.7rem .9rem;color:var(--text);font-family:var(--sans);font-size:.88rem;line-height:1.5;resize:vertical;transition:border-color .2s;outline:none}
.field textarea:focus,.field input:focus{border-color:var(--yellow);box-shadow:0 0 0 3px var(--yellow-dim)}
.field textarea{min-height:70px}.field textarea.short{min-height:48px;resize:none}.field textarea.tall{min-height:110px}
.field-row{display:grid;grid-template-columns:1fr 2fr;gap:.7rem}
.compare-zone{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:.85rem}
.badge{font-size:.55rem;padding:.1rem .3rem;border-radius:3px;text-transform:uppercase;font-weight:600}
.badge-original{background:var(--blue-dim);color:var(--blue)}.badge-yours{background:var(--green-dim);color:var(--green)}
.scope-list{display:flex;flex-direction:column;gap:.45rem}
.scope-item{display:flex;align-items:center;gap:.5rem}
.scope-item input[type="text"]{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:.55rem .8rem;color:var(--text);font-family:var(--sans);font-size:.85rem;outline:none}
.scope-item input[type="text"]:focus{border-color:var(--yellow)}
.scope-item input[type="number"]{width:65px;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:.55rem .5rem;color:var(--orange);font-family:var(--mono);font-size:.8rem;outline:none;text-align:center}
.scope-item .remove-btn{width:26px;height:26px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.95rem}
.scope-item .remove-btn:hover{border-color:var(--red);color:var(--red)}
.scope-item .time-label{font-family:var(--mono);font-size:.6rem;color:var(--text-muted)}
.add-scope-btn{display:inline-flex;align-items:center;gap:.4rem;background:transparent;border:1px dashed var(--border);border-radius:8px;padding:.45rem .8rem;color:var(--text-dim);font-size:.82rem;cursor:pointer;margin-top:.2rem}
.add-scope-btn:hover{border-color:var(--yellow);color:var(--yellow)}
.time-summary{display:flex;align-items:center;gap:.75rem;margin-top:.6rem;padding:.6rem .85rem;background:var(--surface);border:1px solid var(--border);border-radius:10px;font-family:var(--mono);font-size:.78rem}
.ts-label{color:var(--text-dim)}.ts-value{color:var(--orange);font-weight:500}.ts-warn{color:var(--red)}.ts-ok{color:var(--green)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.45rem;padding:.6rem 1.2rem;border-radius:10px;font-family:var(--sans);font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s;border:none;text-align:center}
.btn-primary{background:var(--yellow);color:var(--bg)}.btn-primary:hover{box-shadow:0 0 20px var(--yellow-glow);transform:translateY(-1px)}.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text-dim)}.btn-ghost:hover{border-color:var(--text-dim);color:var(--text)}
.btn-sm{padding:.4rem .8rem;font-size:.78rem;border-radius:8px}
.btn-danger{background:transparent;border:1px solid var(--red);color:var(--red)}.btn-danger:hover{background:var(--red-dim)}
.step-actions{display:flex;gap:.65rem;margin-top:.65rem;margin-bottom:.85rem;flex-wrap:wrap}
.provider-bar{display:flex;gap:.4rem;flex-wrap:wrap}
.provider-btn{font-family:var(--mono);font-size:.68rem;padding:.3rem .65rem;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer;transition:all .2s}
.provider-btn:hover{border-color:var(--text-muted)}.provider-btn.active{border-color:var(--yellow);color:var(--yellow);background:var(--yellow-dim)}
.verify-result{margin-top:.85rem;padding:.85rem;border-radius:12px;border:1px solid var(--border);display:none}
.verify-result.visible{display:block}
.verify-result.verdict-match{border-color:var(--green);background:var(--green-dim)}
.verify-result.verdict-drift{border-color:var(--orange);background:var(--orange-dim)}
.verify-result.verdict-missing{border-color:var(--blue);background:var(--blue-dim)}
.verify-result.verdict-major_mismatch{border-color:var(--red);background:var(--red-dim)}
.vr-header{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem}
.vr-verdict{font-family:var(--mono);font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;padding:.15rem .5rem;border-radius:4px}
.vr-verdict-match{background:var(--green);color:var(--bg)}.vr-verdict-drift{background:var(--orange);color:var(--bg)}.vr-verdict-missing{background:var(--blue);color:#fff}.vr-verdict-major_mismatch{background:var(--red);color:#fff}
.vr-confidence{font-family:var(--mono);font-size:.68rem;color:var(--text-dim)}
.vr-summary{font-size:.88rem;line-height:1.5;margin-bottom:.5rem}
.vr-section{margin-bottom:.4rem}.vr-section-title{font-family:var(--mono);font-size:.65rem;text-transform:uppercase;color:var(--text-dim);margin-bottom:.2rem}
.vr-items{font-size:.82rem;padding-left:1rem}.vr-items li{margin-bottom:.15rem}
.vr-duck-quote{font-style:italic;font-size:.82rem;color:var(--yellow);margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--border)}
.vr-masking{font-family:var(--mono);font-size:.6rem;color:var(--text-muted);margin-top:.4rem}
.verify-loading{display:none;align-items:center;gap:.5rem;font-family:var(--mono);font-size:.78rem;color:var(--yellow);margin-top:.5rem}
.verify-loading.active{display:flex}
.spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--yellow);border-radius:50%;animation:spin .6s linear infinite}
.drift-override{margin-top:.65rem;padding:.65rem;background:var(--orange-dim);border:1px solid var(--orange);border-radius:10px;display:none}
.drift-override.visible{display:block}
.drift-override label{color:var(--orange)!important}
.rescope-loading{display:none;align-items:center;gap:.5rem;font-family:var(--mono);font-size:.78rem;color:var(--blue);margin-top:.5rem}
.rescope-loading.active{display:flex}
.rescope-section{display:none;margin-top:.65rem;padding:.85rem;background:var(--blue-dim);border:1px solid var(--blue);border-radius:12px}
.rescope-section.visible{display:block}
.rescope-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;font-family:var(--mono);font-size:.75rem;font-weight:600;color:var(--blue)}
.rescope-header .dismiss{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:.85rem}
.rescope-changes{margin-bottom:.6rem;font-size:.78rem;line-height:1.5}
.rescope-changes li{margin-bottom:.2rem;color:var(--text-dim);list-style:none;padding-left:.8rem;position:relative}
.rescope-changes li::before{content:'‚Üí';position:absolute;left:0;color:var(--blue)}
.rescope-field{margin-bottom:.5rem}
.rescope-field label{display:block;font-family:var(--mono);font-size:.62rem;text-transform:uppercase;letter-spacing:.08em;color:var(--blue);margin-bottom:.25rem}
.rescope-field textarea{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:.6rem .8rem;color:var(--text);font-family:var(--sans);font-size:.85rem;line-height:1.5;resize:vertical;outline:none;min-height:60px}
.rescope-apply{margin-top:.25rem;border-color:var(--blue)!important;color:var(--blue)!important}
.rescope-apply:hover{background:var(--blue-dim)!important}
.rescope-duck{font-style:italic;font-size:.8rem;color:var(--blue);margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--border)}
.check-q{display:flex;align-items:flex-start;gap:.7rem;padding:.75rem .9rem;background:var(--bg);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all .2s;user-select:none;margin-bottom:.5rem}
.check-q:hover{border-color:var(--text-muted)}.check-q.checked{border-color:var(--green);background:var(--green-dim)}
.check-q .checkbox{width:20px;height:20px;border-radius:5px;border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.7rem;margin-top:1px}
.check-q.checked .checkbox{border-color:var(--green);background:var(--green);color:var(--bg)}
.check-q .check-text{font-size:.85rem;line-height:1.4;color:var(--text-dim)}.check-q.checked .check-text{color:var(--text)}
.peer-section{margin-top:.85rem;padding:.85rem;background:var(--purple-dim);border:1px solid var(--purple);border-radius:10px}
.peer-section label{color:var(--purple)!important}
.diff-section{margin-top:.85rem;padding:.85rem;background:var(--surface);border:1px solid var(--border);border-radius:10px}
.diff-section h4{font-size:.82rem;font-weight:600;margin-bottom:.5rem;color:var(--orange)}
.diff-item{display:flex;align-items:center;gap:.5rem;padding:.35rem 0;font-size:.82rem;border-bottom:1px solid var(--border)}
.diff-item:last-child{border-bottom:none}
.diff-planned{color:var(--text-dim);flex:1}
.diff-status{font-family:var(--mono);font-size:.7rem;padding:.1rem .4rem;border-radius:3px;cursor:pointer;user-select:none}
.diff-done{background:var(--green-dim);color:var(--green)}.diff-skipped{background:var(--red-dim);color:var(--red)}.diff-extra{background:var(--orange-dim);color:var(--orange)}.diff-amended{background:var(--blue-dim);color:var(--blue)}
.diff-add-extra{margin-top:.5rem;display:flex;gap:.4rem}
.diff-add-extra input{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:.4rem .6rem;color:var(--text);font-size:.8rem;outline:none}
.amend-section{margin-top:.65rem;padding:.65rem;background:var(--blue-dim);border:1px solid var(--blue);border-radius:8px}
.amend-section label{color:var(--blue)!important;font-size:.65rem}
.completion{text-align:center;padding:2rem 1rem;display:none}.completion.visible{display:block}
.completion .big-duck{font-size:3.5rem;margin-bottom:.75rem;animation:float 2s ease-in-out infinite}
.completion h2{font-size:1.4rem;font-weight:700;margin-bottom:.4rem;color:var(--green)}
.accuracy-card{display:inline-flex;flex-direction:column;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1rem 1.5rem;margin-bottom:1.25rem}
.accuracy-card .acc-label{font-family:var(--mono);font-size:.65rem;color:var(--text-dim);text-transform:uppercase}.accuracy-card .acc-score{font-size:2rem;font-weight:800;margin:.2rem 0}.accuracy-card .acc-detail{font-size:.78rem;color:var(--text-dim)}
.completion-actions{display:flex;gap:.65rem;justify-content:center;flex-wrap:wrap}
.trend-section{padding:.85rem;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin:.65rem .85rem}
.trend-section h4{font-family:var(--mono);font-size:.72rem;text-transform:uppercase;color:var(--text-dim);margin-bottom:.5rem}
.trend-row{display:flex;gap:1rem;flex-wrap:wrap}.trend-stat{flex:1;min-width:80px;text-align:center}
.trend-stat .ts-num{font-size:1.4rem;font-weight:700}.trend-stat .ts-lbl{font-family:var(--mono);font-size:.6rem;color:var(--text-muted)}
.trend-sparkline{height:40px;display:flex;align-items:flex-end;gap:2px;margin-top:.5rem}
.trend-sparkline .bar{flex:1;background:var(--green);border-radius:2px 2px 0 0;min-width:4px}
.checkpoint-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.checkpoint-overlay.show{opacity:1;pointer-events:all}
.checkpoint-modal{background:var(--surface);border:2px solid var(--yellow);border-radius:18px;padding:2rem;text-align:center;max-width:400px;width:90%;box-shadow:0 0 40px var(--yellow-glow)}
.checkpoint-modal h3{font-size:1.1rem;font-weight:700;margin-bottom:.4rem;color:var(--yellow)}
.checkpoint-modal p{font-size:.88rem;color:var(--text-dim);margin-bottom:1rem}
.checkpoint-modal .cm-scope{text-align:left;background:var(--bg);border-radius:8px;padding:.65rem;margin-bottom:1rem;font-size:.8rem}
.checkpoint-modal .cm-scope li{margin-bottom:.25rem;list-style:none;cursor:pointer;padding:.2rem .4rem;border-radius:4px}
.checkpoint-modal .cm-scope li:hover{background:var(--yellow-dim)}
.checkpoint-modal .cm-scope li.selected{background:var(--yellow-dim);color:var(--yellow)}
.checkpoint-modal .cm-scope li::before{content:'‚Üí ';color:var(--yellow)}
.checkpoint-modal .cm-actions{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap}
.md-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:300;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.md-overlay.show{opacity:1;pointer-events:all}
.md-modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:1.5rem;max-width:600px;width:90%;max-height:80vh;display:flex;flex-direction:column}
.md-modal h3{font-size:1rem;font-weight:600;margin-bottom:.75rem}
.md-modal textarea{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:.75rem;color:var(--green);font-family:var(--mono);font-size:.75rem;resize:none;min-height:300px;outline:none}
.md-modal .md-actions{display:flex;gap:.5rem;margin-top:.75rem;justify-content:flex-end}
.creep-alert{position:fixed;bottom:1.5rem;right:1.5rem;background:var(--surface);border:1px solid var(--red);border-radius:14px;padding:.85rem 1.1rem;display:flex;align-items:center;gap:.65rem;box-shadow:0 8px 30px rgba(0,0,0,.4);z-index:100;transform:translateY(120%);transition:transform .4s cubic-bezier(.34,1.56,.64,1);max-width:320px}
.creep-alert.show{transform:translateY(0)}
.creep-alert .duck-mini{font-size:1.6rem;flex-shrink:0}
.creep-alert p{font-size:.8rem;line-height:1.4}
.creep-alert .dismiss{position:absolute;top:.4rem;right:.55rem;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:.85rem}
.work-timer{position:fixed;top:1rem;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:.35rem .85rem;font-family:var(--mono);font-size:.75rem;color:var(--text-dim);z-index:50;display:none;gap:.5rem;align-items:center}
.work-timer.active{display:flex}.wt-time{color:var(--orange);font-weight:500}.wt-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:.75rem;padding:0 .2rem}.wt-btn:hover{color:var(--yellow)}
.history-panel{position:fixed;top:0;right:-400px;width:380px;height:100vh;background:var(--surface);border-left:1px solid var(--border);z-index:200;transition:right .35s ease;display:flex;flex-direction:column;overflow:hidden}
.history-panel.open{right:0}
.history-panel-header{padding:1.1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.history-panel-header h3{font-size:.95rem;font-weight:600}
.history-panel-header button{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:1.1rem}
.history-list{flex:1;overflow-y:auto;padding:.85rem}
.history-item{padding:.75rem;border:1px solid var(--border);border-radius:10px;margin-bottom:.65rem}
.history-item:hover{border-color:var(--text-muted)}
.history-item .hi-id{font-family:var(--mono);font-size:.65rem;color:var(--yellow)}.history-item .hi-task{font-size:.82rem;font-weight:500;margin-bottom:.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.history-item .hi-meta{display:flex;gap:.75rem;align-items:center}
.history-item .hi-date{font-family:var(--mono);font-size:.63rem;color:var(--text-muted)}
.history-item .hi-badge{font-family:var(--mono);font-size:.55rem;padding:.1rem .3rem;border-radius:3px}
.hi-badge-draft{background:var(--orange-dim);color:var(--orange)}.hi-badge-done{background:var(--green-dim);color:var(--green)}
.history-item .hi-actions{display:flex;gap:.4rem;margin-top:.4rem}
.history-item .hi-actions button{font-family:var(--mono);font-size:.6rem;padding:.2rem .4rem;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer}
.history-item .hi-actions button:hover{border-color:var(--yellow);color:var(--yellow)}
.history-empty{text-align:center;color:var(--text-muted);font-size:.82rem;padding:2rem}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:150;opacity:0;pointer-events:none;transition:opacity .3s}.overlay.show{opacity:1;pointer-events:all}
@media print{*{color:#000!important;background:#fff!important;box-shadow:none!important}body::before,.login-overlay,.sound-toggle,.history-toggle,.work-timer,.history-panel,.overlay,.creep-alert,.checkpoint-overlay,.md-overlay,.autosave-indicator{display:none!important}#printSheet{display:block!important;font-family:'Segoe UI',Arial,sans-serif;font-size:11pt}.app{display:none!important}@page{size:letter;margin:.6in}}
#printSheet{display:none}
@keyframes fadeDown{from{opacity:0;transform:translateY(-15px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
@keyframes quack{0%,100%{transform:scale(1) rotate(0)}25%{transform:scale(1.15) rotate(-8deg)}50%{transform:scale(1.05) rotate(4deg)}75%{transform:scale(1.1) rotate(-3deg)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:600px){.app{padding:1.25rem 1rem}.header h1{font-size:1.5rem}.header .shortcuts-hint{display:none}.duck-zone{flex-direction:column;align-items:center;text-align:center}.step-tag{display:none}.field-row,.compare-zone{grid-template-columns:1fr}.history-panel{width:100%;right:-100%}.trend-row{flex-direction:column}}
input:-webkit-autofill{-webkit-box-shadow:0 0 0 30px var(--bg) inset!important;-webkit-text-fill-color:var(--text)!important}
</style>
</head>
<body>
<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay"><div class="login-box"><div class="login-duck">ü¶Ü</div><h2>Task Duck v4</h2><p class="login-sub">Enter your password to continue</p><div style="position:relative"><input type="password" id="loginPassword" placeholder="Password..." autofocus autocomplete="new-password" data-lpignore="true" data-1p-ignore data-form-type="other" onkeydown="if(event.key==='Enter')doLogin()"><button type="button" class="pw-toggle" onclick="togglePasswordVis()"><svg id="pwEyeShow" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><svg id="pwEyeHide" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg></button></div><div class="login-error" id="loginError"></div><div class="login-lockout" id="loginLockout"></div><button class="btn btn-primary" style="width:100%;justify-content:center" onclick="doLogin()" id="loginBtn">üîì Unlock</button><div class="login-attempts" id="loginAttempts"></div></div></div>

<!-- FIXED UI -->
<button class="sound-toggle" onclick="toggleSound()"><span id="soundIcon">üîá</span><span id="soundLabel">SOUND OFF</span></button>
<button class="history-toggle" onclick="toggleHistory()">üìã History</button>
<div class="work-timer" id="workTimer"><span>‚è±</span><span class="wt-time" id="workTimerDisplay">00:00</span><span style="color:var(--text-muted)">working</span><button class="wt-btn" onclick="toggleWorkTimer()" id="workTimerBtn">‚è∏</button></div>
<div class="autosave-indicator" id="autosaveInd">üíæ Draft saved</div>
<div class="overlay" id="overlay" onclick="toggleHistory()"></div>

<!-- HISTORY PANEL -->
<div class="history-panel" id="historyPanel"><div class="history-panel-header"><h3>üìã Task History</h3><button onclick="toggleHistory()">‚úï</button></div><div id="trendDashboard"></div><div class="history-list" id="historyList"><div class="history-empty">No tasks yet.</div></div></div>

<!-- CHECKPOINT -->
<div class="checkpoint-overlay" id="checkpointOverlay"><div class="checkpoint-modal"><div style="font-size:3rem">ü¶Ü</div><h3>Checkpoint! Still inside the fence?</h3><p id="checkpointMsg">Which scope item are you working on RIGHT NOW?</p><div class="cm-scope"><ul id="checkpointScope"></ul></div><div class="cm-actions"><button class="btn btn-primary btn-sm" onclick="checkpointYes()">‚úì On track</button><button class="btn btn-ghost btn-sm" style="border-color:var(--red);color:var(--red)" onclick="checkpointNo()">‚ö† I drifted</button></div></div></div>

<!-- MARKDOWN -->
<div class="md-overlay" id="mdOverlay"><div class="md-modal"><h3>üìã Markdown Export</h3><textarea id="mdContent" readonly></textarea><div class="md-actions"><button class="btn btn-ghost btn-sm" onclick="closeMd()">Close</button><button class="btn btn-primary btn-sm" onclick="copyMd()">üìã Copy</button></div></div></div>

<!-- CREEP ALERT -->
<div class="creep-alert" id="creepAlert"><div class="duck-mini">ü¶Ü</div><p id="creepMessage">Quack!</p><button class="dismiss" onclick="hideCreep()">‚úï</button></div>

<!-- PRINT SHEET -->
<div id="printSheet"></div>

<!-- MAIN APP -->
<div class="app">
  <div class="header"><h1>ü¶Ü Task <span class="y">Duck</span> <span class="v">v4</span></h1><p>READ ‚Üí PLAN ‚Üí EXECUTE ‚Üí CHECK</p><div class="shortcuts-hint"><kbd>Esc</kbd> duck ¬∑ <kbd>Ctrl+P</kbd> print ¬∑ <kbd>Ctrl+M</kbd> markdown</div></div>

  <div class="duck-zone"><div class="duck-avatar" id="duck" onclick="quackDuck()">ü¶Ü</div><div class="duck-speech"><div class="label">Duck says</div><p id="duckMessage">Paste a task below. I'll keep you honest ‚Äî no scope creep on my watch. ü´°</p></div></div>

  <div id="stepsContainer">
    <!-- STEP 1: READ & REWRITE -->
    <div class="step active" id="step1">
      <div class="step-header" onclick="reopenStep(1)"><div class="step-number"><span>1</span></div><div class="step-title">Read & Rewrite</div><div class="step-tag" style="background:var(--blue-dim);color:var(--blue)">understand</div></div>
      <div class="step-body">
        <div class="field-row" style="margin-bottom:.85rem"><div class="field" style="margin:0"><label>Task ID</label><input type="text" id="taskIdField" placeholder="JIRA-1234..." autocomplete="off" spellcheck="false"></div><div class="field" style="margin:0"><label>Title</label><input type="text" id="taskTitleField" placeholder="Short title..." autocomplete="off"></div></div>
        <div class="compare-zone"><div class="field" style="margin:0"><label>Raw Task <span class="badge badge-original">original</span></label><textarea class="tall" id="rawTaskField" placeholder="Paste the original ticket verbatim..."></textarea></div><div class="field" style="margin:0"><label>Your Understanding <span class="badge badge-yours">rewrite</span></label><textarea class="tall" id="askField" placeholder="Rewrite: what is ACTUALLY being asked?"></textarea></div></div>
        <div class="field"><label>Deliverable</label><textarea class="short" id="deliverableField" placeholder="A PR? Config change? Document?"></textarea></div>
        <div class="field"><label>‚úÖ Definition of Done</label><textarea class="short" id="dodField" placeholder="How do I know I'm finished? Be specific."></textarea></div>
        <div class="field"><label>‚ö† What is NOT being asked?</label><textarea class="short" id="notAskedField" placeholder="Explicitly state what's out of scope..."></textarea></div>
        <div class="step-actions"><div class="provider-bar" id="providerBar"><span style="font-family:var(--mono);font-size:.65rem;color:var(--text-muted);padding:.3rem 0">AI:</span></div><button class="btn btn-ghost btn-sm" onclick="verifyUnderstanding()" id="verifyBtn" disabled>ü¶Ü Verify</button><button class="btn btn-primary" onclick="completeStep(1)" id="step1Btn">Lock it in ‚Üí</button></div>
        <div class="verify-loading" id="verifyLoading"><div class="spinner"></div><span>Masking & verifying...</span></div>
        <div class="verify-result" id="verifyResult"></div>
        <div class="drift-override" id="driftOverride"><div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap"><button class="btn btn-ghost btn-sm" style="border-color:var(--blue);color:var(--blue)" onclick="requestRescope()">ü¶Ü Fix my scope</button><span style="font-family:var(--mono);font-size:.6rem;color:var(--text-muted)">or proceed:</span><input type="text" id="driftReason" placeholder="Why I'm ignoring drift..." style="flex:1;min-width:140px;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:.4rem .6rem;color:var(--text);font-size:.8rem;outline:none"></div></div>
        <div class="rescope-loading" id="rescopeLoading"><div class="spinner"></div><span>Re-scoping...</span></div>
        <div class="rescope-section" id="rescopeSection">
          <div class="rescope-header"><span>ü¶Ü Suggested Re-scope</span><button class="dismiss" onclick="hideRescope()">‚úï</button></div>
          <div class="rescope-changes" id="rescopeChanges"></div>
          <div class="rescope-field"><label>Suggested Rewrite</label><textarea id="rescopeRewrite" readonly></textarea><button class="btn btn-ghost btn-sm rescope-apply" onclick="applyRescope('rewrite')">‚Üë Apply to my rewrite</button></div>
          <div class="rescope-field"><label>Suggested Definition of Done</label><textarea id="rescopeDod" readonly class="short"></textarea><button class="btn btn-ghost btn-sm rescope-apply" onclick="applyRescope('dod')">‚Üë Apply to my DoD</button></div>
          <div class="rescope-duck" id="rescopeDuck"></div>
        </div>
      </div>
    </div>
    <div class="step-connector"></div>

    <!-- STEP 2: PLAN & FENCE -->
    <div class="step" id="step2">
      <div class="step-header" onclick="reopenStep(2)"><div class="step-number"><span>2</span></div><div class="step-title">Plan & Fence</div><div class="step-tag" style="background:var(--yellow-dim);color:var(--yellow)">constrain</div></div>
      <div class="step-body">
        <div class="field"><label>Scope Items (3‚Äì5) ‚Äî estimate minutes</label>
          <div class="scope-list" id="scopeList"></div>
          <button class="add-scope-btn" onclick="addScope()" id="addScopeBtn">+ Add item</button>
          <div class="time-summary" id="timeSummary"><span class="ts-label">Total:</span><span class="ts-value" id="totalTime">0 min</span></div>
        </div>
        <div class="field"><label>üîß Approach ‚Äî files/services I will touch</label><textarea id="approachField" placeholder="List specific files, services, configs you plan to modify..."></textarea></div>
        <div class="peer-section"><div class="field" style="margin-bottom:.5rem"><label>üë• Who reviews this?</label><textarea class="short" id="peerWho" placeholder="Name/team..."></textarea></div><div class="field" style="margin:0"><label>What would SURPRISE them in your diff?</label><textarea class="short" id="peerSurprise" placeholder="Think from reviewer's perspective..."></textarea></div></div>
        <div class="field"><label>üÖø Parking Lot</label><textarea id="parkingLot" placeholder="'While I'm in here...' ideas go HERE, not in your PR."></textarea></div>
        <div class="step-actions"><button class="btn btn-ghost" onclick="goBack(1)">‚Üê Back</button><button class="btn btn-ghost" onclick="printPlan()">üñ®Ô∏è Print Plan</button><button class="btn btn-primary" onclick="completeStep(2)" id="step2Btn">Start working ‚Üí</button></div>
      </div>
    </div>
    <div class="step-connector"></div>

    <!-- STEP 3: EXECUTE -->
    <div class="step" id="step3">
      <div class="step-header" onclick="reopenStep(3)"><div class="step-number"><span>3</span></div><div class="step-title">Execute</div><div class="step-tag" style="background:var(--orange-dim);color:var(--orange)">do the work</div></div>
      <div class="step-body">
        <div class="diff-section"><h4>üìä Diff Tracker ‚Äî Planned vs Actual</h4><div id="diffList"></div>
          <div class="diff-add-extra"><input type="text" id="extraWorkInput" placeholder="Unplanned extra work..."><button class="btn btn-ghost btn-sm" onclick="addExtra()">+ Extra</button></div>
          <div class="amend-section" id="amendSection" style="display:none"><div class="field" style="margin:0"><label>üìã Scope Amendment ‚Äî what and WHY?</label><textarea class="short" id="amendReason" placeholder="I need to add this because the original task is blocked without it..."></textarea></div><button class="btn btn-ghost btn-sm" style="margin-top:.3rem" onclick="submitAmendment()">Submit Amendment</button></div>
          <button class="btn btn-ghost btn-sm" style="margin-top:.4rem;border-color:var(--blue);color:var(--blue)" onclick="showAmendment()">üìã Scope Amendment</button>
        </div>
        <div class="step-actions"><button class="btn btn-ghost" onclick="pauseAndGoBack(2)">‚Üê Review plan</button><button class="btn btn-primary" onclick="completeStep(3)" id="step3Btn">Done working ‚Üí</button></div>
      </div>
    </div>
    <div class="step-connector"></div>

    <!-- STEP 4: PRE-PUSH CHECK -->
    <div class="step" id="step4">
      <div class="step-header" onclick="reopenStep(4)"><div class="step-number"><span>4</span></div><div class="step-title">Pre-Push Check</div><div class="step-tag" style="background:var(--green-dim);color:var(--green)">verify</div></div>
      <div class="step-body">
        <div id="checkQuestions"></div>
        <div class="step-actions"><button class="btn btn-ghost" onclick="goBack(3)">‚Üê Back</button><button class="btn btn-primary" onclick="shipIt()" id="shipBtn" disabled>‚úì Ship it!</button></div>
      </div>
    </div>
  </div>

  <!-- COMPLETION -->
  <div class="completion" id="completionSection">
    <div class="big-duck">ü¶Ü</div>
    <h2>Shipped! üéâ</h2>
    <div class="accuracy-card"><span class="acc-label">Accuracy</span><span class="acc-score" id="accScore">0%</span><span class="acc-detail" id="accDetail"></span></div>
    <p id="completionDuck"></p>
    <div class="completion-actions">
      <button class="btn btn-ghost" onclick="printFinal()">üñ®Ô∏è Print Final</button>
      <button class="btn btn-ghost" onclick="exportMarkdown()">üìã Markdown</button>
      <button class="btn btn-primary" onclick="resetAll()">ü¶Ü New Task</button>
    </div>
  </div>
</div>
<script>
// ============================================
// GLOBALS
// ============================================
const $ = id => document.getElementById(id);
const esc = s => { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; };
let authToken = localStorage.getItem('tdToken') || '';
let selectedProvider = localStorage.getItem('tdProvider') || '';
let availableProviders = [];
let currentStep = 1;
let verifyAttempts = 0;
let lastVerdict = null;
let workTimerInterval = null;
let workTimerSeconds = 0;
let workTimerPaused = false;
let checkpointInterval = null;
let draftId = localStorage.getItem('tdDraftId') || null;
let amendments = [];
let extras = [];
let diffItems = [];
let soundEnabled = localStorage.getItem('tdSound') === 'true';
let bcryptLoaded = false;
let clientLockoutUntil = parseInt(localStorage.getItem('tdLockout') || '0');

const duckQuotes = [
  "Read the words. Not what you WANT the words to say.",
  "If it's not in the ticket, it's not in the scope.",
  "Your reviewer doesn't want surprises. Neither does your duck.",
  "The best code is the code you didn't write.",
  "Scope creep starts with 'while I'm in here...'",
  "Would a junior dev understand why you touched that file?",
  "Ship the task. Not the task + your weekend project.",
  "The parking lot exists for a reason. Use it.",
  "Are you solving the problem, or redesigning the solution?",
  "YAGNI ‚Äî You Aren't Gonna Need It. Trust the duck."
];

// ============================================
// SOUND ‚Äî embedded duck quack mp3
// ============================================
const QUACK_DATA = "./assets/duck-quack.m4a";
function playQuack() {
  if (!soundEnabled) return;
  try {
    console.log('Playing quack sound');
    const audio = new Audio(QUACK_DATA);
    audio.volume = 0.6;
    audio.play().catch(() => {
      console.warn('Quack sound failed to play');
    });
  } catch(e) {}
}
function toggleSound() { soundEnabled=!soundEnabled; localStorage.setItem('tdSound',soundEnabled); updateSoundUI(); if(soundEnabled) playQuack(); }
function updateSoundUI() { $('soundIcon').textContent=soundEnabled?'üîä':'üîá'; $('soundLabel').textContent=soundEnabled?'SOUND ON':'SOUND OFF'; }
updateSoundUI();

// ============================================
// PASSWORD TOGGLE
// ============================================
function togglePasswordVis() { const i=$('loginPassword');const s=$('pwEyeShow'),h=$('pwEyeHide');if(i.type==='password'){i.type='text';s.style.display='none';h.style.display='block';}else{i.type='password';s.style.display='block';h.style.display='none';}i.focus(); }

// ============================================
// LOCKOUT
// ============================================
let lockoutTimer = null;
function startLockoutCountdown(sec) { clientLockoutUntil=Date.now()+(sec*1000); localStorage.setItem('tdLockout',String(clientLockoutUntil)); updateLockoutUI(); }
function updateLockoutUI() {
  const el=$('loginLockout'),btn=$('loginBtn'),pw=$('loginPassword');
  const rem=Math.max(0,Math.ceil((clientLockoutUntil-Date.now())/1000));
  if(rem>0){const m=Math.floor(rem/60),s=rem%60;el.textContent=`üîí Locked ‚Äî ${m}:${String(s).padStart(2,'0')}`;el.style.display='block';btn.disabled=true;pw.disabled=true;lockoutTimer=setTimeout(updateLockoutUI,1000);}
  else{el.style.display='none';btn.disabled=false;pw.disabled=false;localStorage.removeItem('tdLockout');clearTimeout(lockoutTimer);}
}
if(clientLockoutUntil>Date.now()) updateLockoutUI();

// ============================================
// AUTH ‚Äî bcrypt challenge-response
// ============================================
const bcryptScript = document.createElement('script');
bcryptScript.src = 'https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js';
bcryptScript.onload = () => { bcryptLoaded = true; };
document.head.appendChild(bcryptScript);

async function sha256Hex(input) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(input));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function doLogin() {
  const pw=$('loginPassword').value, err=$('loginError'), att=$('loginAttempts'), btn=$('loginBtn');
  err.textContent=''; att.style.display='none';
  if(!pw){err.textContent='Enter a password';return;}
  if(pw.length<8){err.textContent='Min 8 characters';return;}
  if(clientLockoutUntil>Date.now()){updateLockoutUI();return;}
  if(!bcryptLoaded){err.textContent='Loading crypto...';await new Promise(r=>{const iv=setInterval(()=>{if(bcryptLoaded){clearInterval(iv);r();}},100);});err.textContent='';}
  btn.disabled=true; btn.textContent='‚è≥ Hashing...';
  try {
    const cr=await fetch('/api/auth/challenge'); if(cr.status===429){const d=await cr.json();startLockoutCountdown(d.lockedFor);return;}
    const {nonce,timestamp,bcryptSalt}=await cr.json();
    // Extract cost from salt (format: $2a$NN$...)
    const costMatch=bcryptSalt.match(/^\$2[aby]?\$(\d+)\$/);
    const cost=costMatch?parseInt(costMatch[1]):12;
    if(cost>14){err.textContent=`bcrypt cost ${cost} is too high for browser. Set BCRYPT_COST=12 in .env and re-run hash-password.js`;btn.disabled=false;btn.textContent='üîì Unlock';return;}
    const s1=await sha256Hex(pw);
    const bh=dcodeIO.bcrypt.hashSync(s1,bcryptSalt);
    const v=await sha256Hex(bh);
    const proof=await sha256Hex(v+nonce+timestamp);
    const lr=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({proof,timestamp})});
    const ld=await lr.json();
    if(lr.status===429){startLockoutCountdown(ld.lockedFor);playQuack();return;}
    if(!lr.ok){err.textContent='Wrong password';playQuack();if(ld.attemptsRemaining!==undefined){att.textContent=ld.attemptsRemaining>0?`${ld.attemptsRemaining} attempt${ld.attemptsRemaining!==1?'s':''} left`:'No attempts left';att.style.display='block';}return;}
    authToken=ld.token; localStorage.setItem('tdToken',authToken); localStorage.removeItem('tdLockout');
    $('loginOverlay').classList.add('hidden'); await loadProviders();
  } catch(e){err.textContent=e.message||'Connection error';}
  finally{btn.disabled=false;btn.textContent='üîì Unlock';}
}

async function checkAuth() {
  if(!authToken)return;
  try{const r=await fetch('/api/providers',{headers:{'Authorization':`Bearer ${authToken}`}});if(r.ok){$('loginOverlay').classList.add('hidden');await loadProviders();}else{authToken='';localStorage.removeItem('tdToken');}}catch{}
}

async function loadProviders() {
  try{const r=await fetch('/api/providers',{headers:{'Authorization':`Bearer ${authToken}`}});const d=await r.json();availableProviders=d.providers||[];renderProviders();}catch{}
}

let selectedModel = localStorage.getItem('tdModel') || '';

function renderProviders() {
  const bar=$('providerBar');
  bar.innerHTML='<span style="font-family:var(--mono);font-size:.65rem;color:var(--text-muted);padding:.3rem 0">AI:</span>';
  if(!availableProviders.length){$('verifyBtn').disabled=true;return;}
  // Build dropdown
  const sel=document.createElement('select');
  sel.style.cssText='font-family:var(--mono);font-size:.72rem;padding:.3rem .5rem;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--yellow);cursor:pointer;outline:none';
  // Find current selection or auto-select first (cheapest)
  let foundCurrent=false;
  availableProviders.forEach((p,i)=>{
    const opt=document.createElement('option');
    opt.value=i;
    opt.textContent=`${p.name} ${p.cost==='free'?'(free)':p.cost==='low'?'($)':'($$)'}`;
    if(selectedProvider===p.id && selectedModel===p.model){opt.selected=true;foundCurrent=true;}
    sel.appendChild(opt);
  });
  if(!foundCurrent){sel.selectedIndex=0;const first=availableProviders[0];selectedProvider=first.id;selectedModel=first.model;localStorage.setItem('tdProvider',first.id);localStorage.setItem('tdModel',first.model);}
  sel.onchange=()=>{const p=availableProviders[sel.value];selectedProvider=p.id;selectedModel=p.model;localStorage.setItem('tdProvider',p.id);localStorage.setItem('tdModel',p.model);};
  bar.appendChild(sel);
  $('verifyBtn').disabled=false;
}

// ============================================
// DUCK
// ============================================
function duckSay(msg){$('duckMessage').textContent=msg;}
function quackDuck(){const d=$('duck');d.classList.remove('quack');void d.offsetWidth;d.classList.add('quack');duckSay(duckQuotes[Math.floor(Math.random()*duckQuotes.length)]);playQuack();}

// ============================================
// SCOPE ITEMS
// ============================================
function addScope() {
  const list=$('scopeList');
  if(list.children.length>=5){showCreep('5 items max! If you need more, the task is too big.');return;}
  const div=document.createElement('div');div.className='scope-item';
  div.innerHTML='<input type="text" placeholder="I will do this..." oninput="checkScope()"><input type="number" placeholder="min" min="1" max="480" oninput="updateTimeSummary()"><span class="time-label">min</span><button class="remove-btn" onclick="removeScope(this)">√ó</button>';
  list.appendChild(div); updateAddBtn(); scheduleSave();
}
function removeScope(btn){btn.parentElement.remove();updateAddBtn();updateTimeSummary();checkScope();scheduleSave();}
function updateAddBtn(){$('addScopeBtn').style.display=$('scopeList').children.length>=5?'none':'inline-flex';}
function getScopeItems(){return[...document.querySelectorAll('.scope-item')].map(el=>({text:el.querySelector('input[type="text"]').value.trim(),minutes:parseInt(el.querySelector('input[type="number"]').value)||0})).filter(s=>s.text);}
function updateTimeSummary(){const items=getScopeItems();const total=items.reduce((a,b)=>a+b.minutes,0);const el=$('totalTime');el.textContent=total?`${total} min (~${(total/60).toFixed(1)}h)`:'0 min';el.className=total>240?'ts-warn':total>0?'ts-ok':'ts-value';}
function checkScope(){const n=getScopeItems().length;$('step2Btn').disabled=n<1;}
// Init 3 scope items
function initScope(){const list=$('scopeList');list.innerHTML='';for(let i=0;i<3;i++){const div=document.createElement('div');div.className='scope-item';div.innerHTML='<input type="text" placeholder="I will do this..." oninput="checkScope()"><input type="number" placeholder="min" min="1" max="480" oninput="updateTimeSummary()"><span class="time-label">min</span><button class="remove-btn" onclick="removeScope(this)">√ó</button>';list.appendChild(div);}}
initScope();

// ============================================
// STEP NAVIGATION
// ============================================
function activateStep(n) {
  currentStep=n;
  for(let i=1;i<=4;i++){const s=$('step'+i);if(!s)continue;s.classList.remove('active','reopened');if(i<n)s.classList.add('completed');else if(i===n)s.classList.add('active');else s.classList.remove('completed');}
  scheduleSave();
}

function reopenStep(n) {
  if(n>=currentStep)return; // can't reopen future steps
  const s=$('step'+n);
  if(s.classList.contains('reopened')){s.classList.remove('reopened');}
  else{
    // Close any other reopened steps
    for(let i=1;i<currentStep;i++){if(i!==n)$('step'+i)?.classList.remove('reopened');}
    s.classList.add('reopened');
    if(currentStep===3&&workTimerInterval){pauseWorkTimer();duckSay("Timer paused while you review.");}
  }
}

function completeStep(n) {
  if(n===1){
    // If drift detected and no override reason, block
    if(lastVerdict&&lastVerdict!=='match'){
      const reason=$('driftReason').value.trim();
      if(!reason){$('driftOverride').classList.add('visible');duckSay("You had drift. Explain why you're proceeding or re-verify.");playQuack();return;}
    }
    activateStep(2);
    duckSay("Good. Now set your fence ‚Äî what EXACTLY will you do?");
  } else if(n===2){
    const items=getScopeItems();
    if(items.length<1){duckSay("Add at least one scope item before starting work.");playQuack();return;}
    activateStep(3); buildDiffTracker(); startWorkTimer(); startCheckpoints();
    duckSay("Timer started. Stay inside the fence. I'll check in every 30 min.");
  } else if(n===3){
    stopWorkTimer(); stopCheckpoints(); activateStep(4); buildCheckQuestions();
    duckSay("Done? Let's verify before you push.");
  }
}

function goBack(toStep){
  // Reactivate a previous step
  currentStep=toStep;
  for(let i=1;i<=4;i++){const s=$('step'+i);s.classList.remove('active','completed','reopened');if(i<toStep)s.classList.add('completed');else if(i===toStep)s.classList.add('active');}
}

function pauseAndGoBack(toStep){
  if(workTimerInterval)pauseWorkTimer();
  goBack(toStep);
  duckSay("Timer paused. Review your plan, then come back.");
}

// ============================================
// VERIFY UNDERSTANDING (AI)
// ============================================
async function verifyUnderstanding() {
  if(!selectedProvider||!authToken)return;
  const raw=$('rawTaskField').value.trim(), ask=$('askField').value.trim();
  if(!raw||!ask){duckSay("Paste the original AND write your understanding first.");return;}
  const loading=$('verifyLoading'),result=$('verifyResult');
  loading.classList.add('active'); result.classList.remove('visible'); result.className='verify-result';
  $('verifyBtn').disabled=true;
  try{
    const r=await fetch('/api/verify',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${authToken}`},body:JSON.stringify({provider:selectedProvider,model:selectedModel,original:raw,rewrite:ask,deliverable:$('deliverableField').value,notAsked:$('notAskedField').value,definitionOfDone:$('dodField').value})});
    const d=await r.json();
    // Server returns result even on 500 now
    const p=d.result;
    if(!p){throw new Error(d.error||'No response from AI provider');}
    if(p.verdict==='error'){
      result.innerHTML=`<div class="vr-header"><span class="vr-verdict" style="background:var(--red);color:#fff">ERROR</span></div><div class="vr-summary" style="color:var(--red)">${esc(p.summary||d.error||'Unknown error')}</div>${p.duck_quote?`<div class="vr-duck-quote">ü¶Ü "${esc(p.duck_quote)}"</div>`:''}`;
      result.className='verify-result visible verdict-major_mismatch';
      duckSay(d.error||'Verification failed. Try again or switch providers.');
      return;
    }
    lastVerdict=p.verdict; verifyAttempts++;
    let html=`<div class="vr-header"><span class="vr-verdict vr-verdict-${p.verdict}">${p.verdict}</span><span class="vr-confidence">${Math.round((p.confidence||0)*100)}%</span></div>`;
    html+=`<div class="vr-summary">${esc(p.summary||'')}</div>`;
    if(p.scope_drift?.detected)html+=`<div class="vr-section"><div class="vr-section-title">Scope Drift</div><ul class="vr-items">${(p.scope_drift.items||[]).slice(0,4).map(i=>'<li>'+esc(i)+'</li>').join('')}</ul></div>`;
    if(p.missing_items?.detected)html+=`<div class="vr-section"><div class="vr-section-title">Missing from Original</div><ul class="vr-items">${(p.missing_items.items||[]).slice(0,4).map(i=>'<li>'+esc(i)+'</li>').join('')}</ul></div>`;
    if(p.assumptions?.detected)html+=`<div class="vr-section"><div class="vr-section-title">Assumptions</div><ul class="vr-items">${(p.assumptions.items||[]).slice(0,4).map(i=>'<li>'+esc(i)+'</li>').join('')}</ul></div>`;
    if(p.definition_of_done&&!p.definition_of_done.clear)html+=`<div class="vr-section"><div class="vr-section-title">Definition of Done</div><p style="font-size:.82rem">${esc(p.definition_of_done.suggestion||'Make it specific and testable')}</p></div>`;
    if(p.spelling_grammar?.issues?.length)html+=`<div class="vr-section"><div class="vr-section-title">Spelling/Grammar</div><ul class="vr-items">${p.spelling_grammar.issues.slice(0,4).map(i=>'<li>'+esc(i)+'</li>').join('')}</ul></div>`;
    if(p.suggestions?.length)html+=`<div class="vr-section"><div class="vr-section-title">Suggestions</div><ul class="vr-items">${p.suggestions.slice(0,4).map(i=>'<li>'+esc(i)+'</li>').join('')}</ul></div>`;
    if(p.duck_quote)html+=`<div class="vr-duck-quote">ü¶Ü "${esc(p.duck_quote)}"</div>`;
    if(d.masking?.itemsMasked)html+=`<div class="vr-masking">üîí ${d.masking.itemsMasked} sensitive item(s) masked before sending to ${d.provider}</div>`;
    result.innerHTML=html; result.className=`verify-result visible verdict-${p.verdict}`;
    if(p.verdict==='match'){duckSay("Clean match! Lock it in.");$('driftOverride').classList.remove('visible');$('rescopeSection').classList.remove('visible');}
    else{
      playQuack();
      if(verifyAttempts>=2)duckSay("Two misses. Re-read the original from scratch.");
      else duckSay("Drift detected. Fix your rewrite or let me re-scope it.");
      $('driftOverride').classList.add('visible');
      $('verifyBtn').textContent='ü¶Ü Re-verify';
    }
  }catch(e){duckSay('Verify error: '+e.message);result.innerHTML=`<p style="color:var(--red);font-size:.85rem">${esc(e.message)}</p><p style="color:var(--text-muted);font-size:.75rem;margin-top:.4rem">Try again or switch to a different AI provider.</p>`;result.className='verify-result visible verdict-major_mismatch';}
  finally{loading.classList.remove('active');$('verifyBtn').disabled=false;}
}

// ============================================
// RE-SCOPE SUGGESTION
// ============================================
async function requestRescope() {
  if(!selectedProvider||!authToken)return;
  const raw=$('rawTaskField').value.trim(), ask=$('askField').value.trim();
  if(!raw||!ask){duckSay("Need both original and your rewrite to suggest a re-scope.");return;}
  const loading=$('rescopeLoading'),section=$('rescopeSection');
  loading.classList.add('active'); section.classList.remove('visible');
  // Gather drift summary from last verify result
  const vrEl=$('verifyResult');
  const driftSummary=vrEl?vrEl.textContent.substring(0,500):'Drift detected';
  try{
    const r=await fetch('/api/rescope',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${authToken}`},body:JSON.stringify({provider:selectedProvider,model:selectedModel,original:raw,rewrite:ask,dod:$('dodField').value,driftSummary})});
    const d=await r.json();
    if(!r.ok)throw new Error(d.error||'Re-scope failed');
    const p=d.result;
    if(!p)throw new Error('No suggestion returned');
    // Populate suggestion fields
    $('rescopeRewrite').value=p.corrected_rewrite||'';
    $('rescopeDod').value=p.corrected_dod||'';
    $('rescopeChanges').innerHTML=(p.changes_made||[]).map(c=>`<li>${esc(c)}</li>`).join('');
    $('rescopeDuck').textContent=p.duck_quote?`ü¶Ü "${p.duck_quote}"`:'';
    section.classList.add('visible');
    duckSay("Here's my suggestion. Review it ‚Äî don't blindly accept!");
  }catch(e){duckSay('Re-scope error: '+e.message);}
  finally{loading.classList.remove('active');}
}
function applyRescope(field){
  if(field==='rewrite'){$('askField').value=$('rescopeRewrite').value;duckSay("Rewrite updated. Re-verify to confirm it matches now.");}
  else if(field==='dod'){$('dodField').value=$('rescopeDod').value;duckSay("Definition of Done updated. Re-verify!");}
  playQuack(); scheduleSave();
}
function hideRescope(){$('rescopeSection').classList.remove('visible');}

// ============================================
// DIFF TRACKER
// ============================================
function buildDiffTracker() {
  const scope=getScopeItems(); diffItems=scope.map((s,i)=>({text:s.text,minutes:s.minutes,status:'pending',type:'planned',idx:i}));
  extras=[]; amendments=[];
  renderDiff();
}
function renderDiff() {
  const el=$('diffList');
  const all=[...diffItems,...extras,...amendments];
  el.innerHTML=all.map((item,i)=>{
    const st=item.status==='done'?'diff-done':item.status==='skipped'?'diff-skipped':item.type==='extra'?'diff-extra':item.type==='amendment'?'diff-amended':'';
    const label=item.status==='done'?'DONE':item.status==='skipped'?'SKIP':item.type==='extra'?'EXTRA':item.type==='amendment'?'AMEND':'TODO';
    return `<div class="diff-item"><span class="diff-planned">${esc(item.text)}</span><span class="diff-status ${st}" onclick="toggleDiffStatus(${i},'${item.type}')">${label}</span></div>`;
  }).join('');
}
function toggleDiffStatus(idx,type) {
  let item; if(type==='extra')item=extras[idx-diffItems.length]; else if(type==='amendment')item=amendments[idx-diffItems.length-extras.length]; else item=diffItems[idx];
  if(!item)return;
  if(item.type==='planned'){item.status=item.status==='pending'?'done':item.status==='done'?'skipped':'pending';}
  renderDiff(); scheduleSave();
}
function addExtra() {
  const inp=$('extraWorkInput'),v=inp.value.trim(); if(!v)return;
  extras.push({text:v,status:'done',type:'extra'}); inp.value=''; renderDiff(); playQuack();
  showCreep("Extra work added. Is this really needed for the task?"); scheduleSave();
}
function showAmendment(){$('amendSection').style.display='block';}
function submitAmendment() {
  const reason=$('amendReason').value.trim(); if(!reason)return;
  amendments.push({text:reason,status:'done',type:'amendment'}); $('amendReason').value=''; $('amendSection').style.display='none';
  renderDiff(); duckSay("Scope amendment recorded. This won't penalize your accuracy score."); scheduleSave();
}

// ============================================
// WORK TIMER
// ============================================
function startWorkTimer(){workTimerSeconds=0;workTimerPaused=false;$('workTimer').classList.add('active');$('workTimerBtn').textContent='‚è∏';workTimerInterval=setInterval(()=>{if(!workTimerPaused){workTimerSeconds++;updateTimerDisplay();}},1000);}
function updateTimerDisplay(){const m=Math.floor(workTimerSeconds/60),s=workTimerSeconds%60;$('workTimerDisplay').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
function toggleWorkTimer(){workTimerPaused=!workTimerPaused;$('workTimerBtn').textContent=workTimerPaused?'‚ñ∂':'‚è∏';}
function pauseWorkTimer(){workTimerPaused=true;$('workTimerBtn').textContent='‚ñ∂';}
function stopWorkTimer(){clearInterval(workTimerInterval);workTimerInterval=null;$('workTimer').classList.remove('active');}

// ============================================
// CHECKPOINTS
// ============================================
function startCheckpoints(){checkpointInterval=setInterval(showCheckpoint,30*60*1000);}
function stopCheckpoints(){clearInterval(checkpointInterval);}
function showCheckpoint(){
  const scope=getScopeItems();
  $('checkpointScope').innerHTML=scope.map((s,i)=>`<li onclick="this.classList.toggle('selected')" data-idx="${i}">${esc(s.text)}</li>`).join('');
  $('checkpointOverlay').classList.add('show'); playQuack();
}
function checkpointYes(){$('checkpointOverlay').classList.remove('show');duckSay("Good. Keep going.");}
function checkpointNo(){$('checkpointOverlay').classList.remove('show');showCreep("You drifted! Stop. Check your scope list. Get back on track.");duckSay("Drift detected during work. Review your scope fence.");}

// ============================================
// PRE-PUSH CHECKS
// ============================================
function buildCheckQuestions(){
  const dod=$('dodField').value.trim();
  const approach=$('approachField').value.trim();
  const hasExtras=extras.length>0;
  const checks=[
    dod?`My Definition of Done is met: "${dod}"`:'I completed what was asked',
    'My diff only contains changes related to the task',
    approach?`I only touched files/services listed in my approach`:'I didn\'t modify unexpected files',
    'My reviewer would NOT ask "why did you change this?"',
    'No gold-plating ‚Äî I shipped what was asked, nothing more',
  ];
  if(hasExtras)checks.push('Each unplanned extra item is justified and necessary');
  $('checkQuestions').innerHTML=checks.map(c=>`<div class="check-q" onclick="toggleCheck(this)"><div class="checkbox"></div><div class="check-text">${esc(c)}</div></div>`).join('');
  updateShipBtn();
}
function toggleCheck(el){el.classList.toggle('checked');el.querySelector('.checkbox').textContent=el.classList.contains('checked')?'‚úì':'';updateShipBtn();}
function updateShipBtn(){const all=document.querySelectorAll('.check-q'),checked=document.querySelectorAll('.check-q.checked');$('shipBtn').disabled=checked.length<all.length;}

// ============================================
// SHIP IT
// ============================================
function shipIt(){
  const scope=getScopeItems();
  const planned=diffItems.length, done=diffItems.filter(d=>d.status==='done').length;
  const extraCount=extras.length, amendCount=amendments.length;
  const deduction=extraCount*10;
  const pct=planned>0?Math.round((done/planned)*100):0;
  const score=Math.max(0,pct-deduction);
  $('accScore').textContent=score+'%';
  $('accScore').style.color=score>=80?'var(--green)':score>=50?'var(--orange)':'var(--red)';
  $('accDetail').textContent=`${done}/${planned} planned ¬∑ ${extraCount} extra ¬∑ ${amendCount} amended`;
  const msg=score>=80?"Clean ship! That's my architect! ü¶Ü‚ú®":score>=50?"Decent, but some drift. Review what pulled you off track.":"Significant drift. Let's tighten the fence next time.";
  $('completionDuck').textContent='ü¶Ü "'+msg+'"';
  duckSay(msg);
  $('completionSection').classList.add('visible');
  // Hide steps
  document.querySelectorAll('.step,.step-connector').forEach(el=>el.style.display='none');
  saveToHistory(score,done,planned,extraCount,amendCount);
  removeDraft();
}

// ============================================
// HISTORY ‚Äî localStorage
// ============================================
function getHistory(){try{return JSON.parse(localStorage.getItem('tdHistory')||'[]');}catch{return[];}}
function saveHistory(h){localStorage.setItem('tdHistory',JSON.stringify(h));}
function saveToHistory(score,done,total,extras,amends){
  const h=getHistory();
  h.unshift({id:Date.now(),taskId:$('taskIdField').value,title:$('taskTitleField').value,date:new Date().toISOString(),score,done,total,extras,amends,
    raw:$('rawTaskField').value,ask:$('askField').value,deliverable:$('deliverableField').value,dod:$('dodField').value,notAsked:$('notAskedField').value,
    approach:$('approachField').value,peerWho:$('peerWho').value,peerSurprise:$('peerSurprise').value,parkingLot:$('parkingLot').value,
    scope:getScopeItems(),driftReason:$('driftReason').value,lastVerdict,workTime:workTimerSeconds,
    diffItems,extraItems:extras,amendItems:amends,status:'done'});
  if(h.length>50)h.length=50;
  saveHistory(h); renderHistory();
}

function renderHistory(){
  const h=getHistory(), el=$('historyList');
  if(!h.length){el.innerHTML='<div class="history-empty">No tasks yet.</div>';renderTrend([]);return;}
  el.innerHTML=h.map((item,i)=>{
    const badge=item.status==='draft'?'<span class="hi-badge hi-badge-draft">DRAFT</span>':'<span class="hi-badge hi-badge-done">DONE</span>';
    const acc=item.status==='done'?`<span class="hi-accuracy" style="color:${item.score>=80?'var(--green)':item.score>=50?'var(--orange)':'var(--red)'}">${item.score}%</span>`:'';
    return `<div class="history-item">
      <div class="hi-id">${esc(item.taskId||'No ID')}</div>
      <div class="hi-task">${esc(item.title||item.ask?.substring(0,60)||'Untitled')}</div>
      <div class="hi-meta"><span class="hi-date">${new Date(item.date).toLocaleDateString()}</span>${badge}${acc}</div>
      <div class="hi-actions">
        <button onclick="resumeTask(${i})">Resume</button>
        <button onclick="cloneTask(${i})">Clone</button>
        <button onclick="deleteTask(${i})">Delete</button>
      </div>
    </div>`;
  }).join('');
  renderTrend(h.filter(x=>x.status==='done'));
}

function resumeTask(idx){
  const h=getHistory(),item=h[idx];if(!item)return;
  resetAll(true);
  $('taskIdField').value=item.taskId||'';$('taskTitleField').value=item.title||'';
  $('rawTaskField').value=item.raw||'';$('askField').value=item.ask||'';
  $('deliverableField').value=item.deliverable||'';$('dodField').value=item.dod||'';
  $('notAskedField').value=item.notAsked||'';$('approachField').value=item.approach||'';
  $('peerWho').value=item.peerWho||'';$('peerSurprise').value=item.peerSurprise||'';
  $('parkingLot').value=item.parkingLot||'';$('driftReason').value=item.driftReason||'';
  if(item.scope?.length){$('scopeList').innerHTML='';item.scope.forEach(s=>{addScope();const items=$('scopeList').children;const last=items[items.length-1];last.querySelector('input[type="text"]').value=s.text;last.querySelector('input[type="number"]').value=s.minutes||'';});}
  lastVerdict=item.lastVerdict||null;
  toggleHistory(); duckSay("Task loaded. Pick up where you left off.");
}

function cloneTask(idx){
  const h=getHistory(),item=h[idx];if(!item)return;
  resetAll(true);
  $('rawTaskField').value=item.raw||'';$('deliverableField').value=item.deliverable||'';
  $('notAskedField').value=item.notAsked||'';
  toggleHistory(); duckSay("Cloned! Rewrite your understanding fresh for this run.");
}

function deleteTask(idx){if(!confirm('Delete this task?'))return;const h=getHistory();h.splice(idx,1);saveHistory(h);renderHistory();}

// ============================================
// TREND DASHBOARD
// ============================================
function renderTrend(done){
  const el=$('trendDashboard');
  if(done.length<3){el.innerHTML='';return;}
  const recent=done.slice(0,20);
  const avgScore=Math.round(recent.reduce((a,b)=>a+b.score,0)/recent.length);
  const avgTime=Math.round(recent.filter(x=>x.workTime).reduce((a,b)=>a+b.workTime,0)/recent.filter(x=>x.workTime).length/60);
  const totalExtras=recent.reduce((a,b)=>a+(b.extras||0),0);
  const maxScore=Math.max(...recent.map(x=>x.score),1);
  const bars=recent.slice().reverse().map(x=>`<div class="bar" style="height:${Math.max(4,(x.score/maxScore)*40)}px;background:${x.score>=80?'var(--green)':x.score>=50?'var(--orange)':'var(--red)'}"></div>`).join('');
  el.innerHTML=`<div class="trend-section"><h4>üìà Trends (last ${recent.length} tasks)</h4><div class="trend-row"><div class="trend-stat"><div class="ts-num" style="color:${avgScore>=80?'var(--green)':avgScore>=50?'var(--orange)':'var(--red)'}">${avgScore}%</div><div class="ts-lbl">Avg accuracy</div></div><div class="trend-stat"><div class="ts-num" style="color:var(--orange)">${avgTime}m</div><div class="ts-lbl">Avg time</div></div><div class="trend-stat"><div class="ts-num" style="color:var(--purple)">${totalExtras}</div><div class="ts-lbl">Total extras</div></div></div><div class="trend-sparkline">${bars}</div></div>`;
}

// ============================================
// AUTOSAVE DRAFTS
// ============================================
let saveTimer=null;
function scheduleSave(){clearTimeout(saveTimer);saveTimer=setTimeout(saveDraft,5000);}
function saveDraft(){
  const data={taskId:$('taskIdField').value,title:$('taskTitleField').value,raw:$('rawTaskField').value,ask:$('askField').value,deliverable:$('deliverableField').value,dod:$('dodField').value,notAsked:$('notAskedField').value,approach:$('approachField').value,peerWho:$('peerWho').value,peerSurprise:$('peerSurprise').value,parkingLot:$('parkingLot').value,driftReason:$('driftReason').value,scope:getScopeItems(),currentStep,lastVerdict,status:'draft',date:new Date().toISOString()};
  if(!data.raw&&!data.ask&&!data.title)return; // nothing to save
  localStorage.setItem('tdDraft',JSON.stringify(data));
  const ind=$('autosaveInd');ind.classList.add('show');setTimeout(()=>ind.classList.remove('show'),1500);
}
function loadDraft(){
  try{const d=JSON.parse(localStorage.getItem('tdDraft'));if(!d)return false;
  $('taskIdField').value=d.taskId||'';$('taskTitleField').value=d.title||'';
  $('rawTaskField').value=d.raw||'';$('askField').value=d.ask||'';
  $('deliverableField').value=d.deliverable||'';$('dodField').value=d.dod||'';
  $('notAskedField').value=d.notAsked||'';$('approachField').value=d.approach||'';
  $('peerWho').value=d.peerWho||'';$('peerSurprise').value=d.peerSurprise||'';
  $('parkingLot').value=d.parkingLot||'';$('driftReason').value=d.driftReason||'';
  lastVerdict=d.lastVerdict||null;
  if(d.scope?.length){$('scopeList').innerHTML='';d.scope.forEach(s=>{addScope();const items=$('scopeList').children;const last=items[items.length-1];last.querySelector('input[type="text"]').value=s.text;last.querySelector('input[type="number"]').value=s.minutes||'';});}
  return true;}catch{return false;}
}
function removeDraft(){localStorage.removeItem('tdDraft');}

// ============================================
// PRINT
// ============================================
function printPlan(){
  const scope=getScopeItems();
  const total=scope.reduce((a,b)=>a+b.minutes,0);
  let h=`<h1 style="font-size:16pt;margin-bottom:2pt">ü¶Ü Task Duck ‚Äî Working Checklist</h1>`;
  h+=`<p style="font-size:9pt;color:#666;margin-bottom:10pt">${new Date().toLocaleDateString()} ¬∑ ${$('taskIdField').value||'No ID'} ¬∑ ${$('taskTitleField').value||''}</p><hr style="margin:8pt 0">`;
  h+=`<h3 style="font-size:11pt;margin:6pt 0 3pt">What's Being Asked</h3><p style="font-size:10pt">${esc($('askField').value)}</p>`;
  h+=`<h3 style="font-size:11pt;margin:6pt 0 3pt">Deliverable</h3><p style="font-size:10pt">${esc($('deliverableField').value)}</p>`;
  h+=`<h3 style="font-size:11pt;margin:6pt 0 3pt">Definition of Done</h3><p style="font-size:10pt">${esc($('dodField').value)}</p>`;
  h+=`<h3 style="font-size:11pt;margin:6pt 0 3pt">NOT In Scope</h3><p style="font-size:10pt;color:#c00">${esc($('notAskedField').value)}</p><hr style="margin:8pt 0">`;
  h+=`<h3 style="font-size:11pt;margin:6pt 0 3pt">Scope Checklist (${total} min)</h3>`;
  scope.forEach(s=>{h+=`<div style="margin:4pt 0;font-size:10pt">‚òê ${esc(s.text)} <span style="color:#888">(${s.minutes}m)</span></div>`;});
  if($('approachField').value){h+=`<h3 style="font-size:11pt;margin:6pt 0 3pt">Approach</h3><p style="font-size:10pt">${esc($('approachField').value)}</p>`;}
  if($('peerWho').value){h+=`<h3 style="font-size:11pt;margin:6pt 0 3pt">Reviewer</h3><p style="font-size:10pt">${esc($('peerWho').value)}</p>`;}
  if($('parkingLot').value){h+=`<h3 style="font-size:11pt;margin:6pt 0 3pt">Parking Lot (NOT doing now)</h3><p style="font-size:10pt;color:#888">${esc($('parkingLot').value)}</p>`;}
  if(lastVerdict&&lastVerdict!=='match'&&$('driftReason').value){h+=`<h3 style="font-size:11pt;margin:6pt 0 3pt;color:#c00">‚ö† Known Drift</h3><p style="font-size:10pt">${esc($('driftReason').value)}</p>`;}
  h+=`<hr style="margin:10pt 0"><p style="font-size:8pt;color:#999">Generated by Task Duck v4 ¬∑ ${new Date().toLocaleString()}</p>`;
  $('printSheet').innerHTML=h; window.print();
}

function printFinal(){
  const scope=getScopeItems();
  let h=`<h1 style="font-size:16pt;margin-bottom:2pt">ü¶Ü Task Duck ‚Äî Final Report</h1>`;
  h+=`<p style="font-size:9pt;color:#666;margin-bottom:10pt">${new Date().toLocaleDateString()} ¬∑ ${$('taskIdField').value||''} ¬∑ ${$('taskTitleField').value||''}</p><hr>`;
  h+=`<h3 style="margin:6pt 0 3pt">Understanding</h3><p style="font-size:10pt">${esc($('askField').value)}</p>`;
  h+=`<h3 style="margin:6pt 0 3pt">Definition of Done</h3><p style="font-size:10pt">${esc($('dodField').value)}</p>`;
  h+=`<h3 style="margin:6pt 0 3pt">Accuracy: ${$('accScore').textContent}</h3><p style="font-size:10pt">${$('accDetail').textContent}</p>`;
  h+=`<h3 style="margin:6pt 0 3pt">Diff</h3>`;
  diffItems.forEach(d=>{h+=`<div style="font-size:10pt;margin:2pt 0">${d.status==='done'?'‚úÖ':'‚ùå'} ${esc(d.text)}</div>`;});
  if(extras.length){h+=`<h4 style="margin:4pt 0;color:#c00">Extras</h4>`;extras.forEach(e=>{h+=`<div style="font-size:10pt;margin:2pt 0">‚ö† ${esc(e.text)}</div>`;});}
  if(amendments.length){h+=`<h4 style="margin:4pt 0;color:#36f">Amendments</h4>`;amendments.forEach(a=>{h+=`<div style="font-size:10pt;margin:2pt 0">üìã ${esc(a.text)}</div>`;});}
  h+=`<hr><p style="font-size:8pt;color:#999">Task Duck v4 ¬∑ ${new Date().toLocaleString()}</p>`;
  $('printSheet').innerHTML=h; window.print();
}

// ============================================
// MARKDOWN EXPORT
// ============================================
function exportMarkdown(){
  const d=gatherData(),scope=getScopeItems();
  let md=`## ü¶Ü Task Duck ‚Äî ${d.taskId} ${d.title}\n\n**Date:** ${new Date().toLocaleDateString()}\n\n`;
  md+=`### What's Being Asked\n${d.ask}\n\n### Deliverable\n${d.deliverable}\n\n### Definition of Done\n${d.dod}\n\n### NOT In Scope\n${d.notAsked}\n\n`;
  md+=`### Scope\n${scope.map(s=>`- [ ] ${s.text} (${s.minutes}m)`).join('\n')}\n\n`;
  if(d.approach)md+=`### Approach\n${d.approach}\n\n`;
  if(d.parkingLot)md+=`### Parking Lot\n${d.parkingLot}\n\n`;
  $('mdContent').value=md; $('mdOverlay').classList.add('show');
}
function closeMd(){$('mdOverlay').classList.remove('show');}
function copyMd(){navigator.clipboard.writeText($('mdContent').value);duckSay("Markdown copied!");}

function gatherData(){return{taskId:$('taskIdField').value,title:$('taskTitleField').value,raw:$('rawTaskField').value,ask:$('askField').value,deliverable:$('deliverableField').value,dod:$('dodField').value,notAsked:$('notAskedField').value,approach:$('approachField').value,peerWho:$('peerWho').value,peerSurprise:$('peerSurprise').value,parkingLot:$('parkingLot').value};}

// ============================================
// CREEP ALERT
// ============================================
function showCreep(msg){$('creepMessage').textContent=msg;$('creepAlert').classList.add('show');playQuack();setTimeout(hideCreep,6000);}
function hideCreep(){$('creepAlert').classList.remove('show');}

// ============================================
// HISTORY TOGGLE
// ============================================
function toggleHistory(){$('historyPanel').classList.toggle('open');$('overlay').classList.toggle('show');}

// ============================================
// RESET
// ============================================
function resetAll(silent){
  ['rawTaskField','askField','deliverableField','dodField','notAskedField','taskIdField','taskTitleField','approachField','peerWho','peerSurprise','parkingLot','driftReason'].forEach(id=>{$(id).value='';});
  initScope(); updateTimeSummary();
  lastVerdict=null; verifyAttempts=0; extras=[]; amendments=[]; diffItems=[];
  $('verifyResult').className='verify-result'; $('verifyResult').innerHTML='';
  $('driftOverride').classList.remove('visible');
  $('rescopeSection').classList.remove('visible');
  $('completionSection').classList.remove('visible');
  document.querySelectorAll('.step,.step-connector').forEach(el=>el.style.display='');
  $('verifyBtn').textContent='ü¶Ü Verify';
  activateStep(1); stopWorkTimer(); stopCheckpoints();
  if(!silent){removeDraft();duckSay("Fresh start! Paste a new task below.");}
}

// ============================================
// KEYBOARD SHORTCUTS
// ============================================
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){quackDuck();}
  if(e.ctrlKey&&e.key==='p'){e.preventDefault();if(currentStep>=2)printPlan();else window.print();}
  if(e.ctrlKey&&e.key==='m'){e.preventDefault();exportMarkdown();}
});

// Auto-save on any input
document.addEventListener('input',()=>scheduleSave());

// ============================================
// INIT
// ============================================
checkAuth();
renderHistory();
if(loadDraft()){duckSay("Welcome back! I recovered your draft. Pick up where you left off.");}
</script>
</body>
</html>
