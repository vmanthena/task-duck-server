<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¦† Task Duck v4 â€” Stay in Scope</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./main.css">
</head>
<body>
<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay"><div class="login-box"><div class="login-duck">ğŸ¦†</div><h2>Task Duck v4</h2><p class="login-sub">Enter your password to continue</p><div style="position:relative"><input type="password" id="loginPassword" placeholder="Password..." autofocus autocomplete="new-password" data-lpignore="true" data-1p-ignore data-form-type="other" onkeydown="if(event.key==='Enter')doLogin()"><button type="button" class="pw-toggle" onclick="togglePasswordVis()"><svg id="pwEyeShow" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><svg id="pwEyeHide" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg></button></div><div class="login-error" id="loginError"></div><div class="login-lockout" id="loginLockout"></div><button class="btn btn-primary" style="width:100%;justify-content:center" onclick="doLogin()" id="loginBtn">ğŸ”“ Unlock</button><div class="login-attempts" id="loginAttempts"></div></div></div>

<!-- FIXED UI -->
<button class="sound-toggle" onclick="toggleSound()"><span id="soundIcon">ğŸ”‡</span><span id="soundLabel">SOUND OFF</span></button>
<button class="history-toggle" onclick="toggleHistory()">ğŸ“‹ History</button>
<div class="work-timer" id="workTimer"><span>â±</span><span class="wt-time" id="workTimerDisplay">00:00</span><span style="color:var(--text-muted)">working</span><button class="wt-btn" onclick="toggleWorkTimer()" id="workTimerBtn">â¸</button></div>
<div class="autosave-indicator" id="autosaveInd">ğŸ’¾ Draft saved</div>
<div class="overlay" id="overlay" onclick="toggleHistory()"></div>

<!-- HISTORY PANEL -->
<div class="history-panel" id="historyPanel"><div class="history-panel-header"><h3>ğŸ“‹ Task History</h3><button onclick="toggleHistory()">âœ•</button></div><div id="trendDashboard"></div><div class="history-list" id="historyList"><div class="history-empty">No tasks yet.</div></div></div>

<!-- CHECKPOINT -->
<div class="checkpoint-overlay" id="checkpointOverlay"><div class="checkpoint-modal"><div style="font-size:3rem">ğŸ¦†</div><h3>Checkpoint! Still inside the fence?</h3><p id="checkpointMsg">Which scope item are you working on RIGHT NOW?</p><div class="cm-scope"><ul id="checkpointScope"></ul></div><div class="cm-actions"><button class="btn btn-primary btn-sm" onclick="checkpointYes()">âœ“ On track</button><button class="btn btn-ghost btn-sm" style="border-color:var(--red);color:var(--red)" onclick="checkpointNo()">âš  I drifted</button></div></div></div>

<!-- MARKDOWN -->
<div class="md-overlay" id="mdOverlay"><div class="md-modal"><h3>ğŸ“‹ Markdown Export</h3><textarea id="mdContent" readonly></textarea><div class="md-actions"><button class="btn btn-ghost btn-sm" onclick="closeMd()">Close</button><button class="btn btn-primary btn-sm" onclick="copyMd()">ğŸ“‹ Copy</button></div></div></div>

<!-- CREEP ALERT -->
<div class="creep-alert" id="creepAlert"><div class="duck-mini">ğŸ¦†</div><p id="creepMessage">Quack!</p><button class="dismiss" onclick="hideCreep()">âœ•</button></div>

<!-- PRINT SHEET -->
<div id="printSheet"></div>

<!-- MAIN APP -->
<div class="app">
  <div class="header"><h1>ğŸ¦† Task <span class="y">Duck</span> <span class="v">v4</span></h1><p>READ â†’ PLAN â†’ EXECUTE â†’ CHECK</p><div class="shortcuts-hint"><kbd>Esc</kbd> duck Â· <kbd>Ctrl+P</kbd> print Â· <kbd>Ctrl+M</kbd> markdown</div></div>

  <div class="duck-zone"><div class="duck-avatar" id="duck" onclick="quackDuck()">ğŸ¦†</div><div class="duck-speech"><div class="label">Duck says</div><p id="duckMessage">Paste a task below. I'll keep you honest â€” no scope creep on my watch. ğŸ«¡</p></div></div>

  <div id="stepsContainer">
    <!-- STEP 1: READ & REWRITE -->
    <div class="step active" id="step1">
      <div class="step-header" onclick="reopenStep(1)"><div class="step-number"><span>1</span></div><div class="step-title">Read & Rewrite</div><div class="step-tag" style="background:var(--blue-dim);color:var(--blue)">understand</div></div>
      <div class="step-body">
        <div class="field-row" style="margin-bottom:.85rem"><div class="field" style="margin:0"><label>Task ID</label><input type="text" id="taskIdField" placeholder="JIRA-1234..." autocomplete="off" spellcheck="false"></div><div class="field" style="margin:0"><label>Title</label><input type="text" id="taskTitleField" placeholder="Short title..." autocomplete="off"></div></div>
        <div class="compare-zone"><div class="field" style="margin:0"><label>Raw Task <span class="badge badge-original">original</span></label><textarea class="tall" id="rawTaskField" placeholder="Paste the original ticket verbatim..."></textarea></div><div class="field" style="margin:0"><label>Your Understanding <span class="badge badge-yours">rewrite</span></label><textarea class="tall" id="askField" placeholder="Rewrite: what is ACTUALLY being asked?"></textarea></div></div>
        <div class="field"><label>Deliverable</label><textarea class="short" id="deliverableField" placeholder="A PR? Config change? Document?"></textarea></div>
        <div class="field"><label>âœ… Definition of Done</label><textarea class="short" id="dodField" placeholder="How do I know I'm finished? Be specific."></textarea></div>
        <div class="field"><label>âš  What is NOT being asked?</label><textarea class="short" id="notAskedField" placeholder="Explicitly state what's out of scope..."></textarea></div>
        <div class="step-actions"><div class="provider-bar" id="providerBar"><span style="font-family:var(--mono);font-size:.65rem;color:var(--text-muted);padding:.3rem 0">AI:</span></div><button class="btn btn-ghost btn-sm" onclick="verifyUnderstanding()" id="verifyBtn" disabled>ğŸ¦† Verify</button><button class="btn btn-primary" onclick="completeStep(1)" id="step1Btn">Lock it in â†’</button></div>
        <div class="verify-loading" id="verifyLoading"><div class="spinner"></div><span>Masking & verifying...</span></div>
        <div class="verify-result" id="verifyResult"></div>
        <div class="drift-override" id="driftOverride"><div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap"><button class="btn btn-ghost btn-sm" style="border-color:var(--blue);color:var(--blue)" onclick="requestRescope()">ğŸ¦† Fix my scope</button><span style="font-family:var(--mono);font-size:.6rem;color:var(--text-muted)">or proceed:</span><input type="text" id="driftReason" placeholder="Why I'm ignoring drift..." style="flex:1;min-width:140px;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:.4rem .6rem;color:var(--text);font-size:.8rem;outline:none"></div></div>
        <div class="rescope-loading" id="rescopeLoading"><div class="spinner"></div><span>Re-scoping...</span></div>
        <div class="rescope-section" id="rescopeSection">
          <div class="rescope-header"><span>ğŸ¦† Suggested Re-scope</span><button class="dismiss" onclick="hideRescope()">âœ•</button></div>
          <div class="rescope-changes" id="rescopeChanges"></div>
          <div class="rescope-field"><label>Suggested Rewrite</label><textarea id="rescopeRewrite" readonly></textarea><button class="btn btn-ghost btn-sm rescope-apply" onclick="applyRescope('rewrite')">â†‘ Apply to my rewrite</button></div>
          <div class="rescope-field"><label>Suggested Definition of Done</label><textarea id="rescopeDod" readonly class="short"></textarea><button class="btn btn-ghost btn-sm rescope-apply" onclick="applyRescope('dod')">â†‘ Apply to my DoD</button></div>
          <div class="rescope-duck" id="rescopeDuck"></div>
        </div>
      </div>
    </div>
    <div class="step-connector"></div>

    <!-- STEP 2: PLAN & FENCE -->
    <div class="step" id="step2">
      <div class="step-header" onclick="reopenStep(2)"><div class="step-number"><span>2</span></div><div class="step-title">Plan & Fence</div><div class="step-tag" style="background:var(--yellow-dim);color:var(--yellow)">constrain</div></div>
      <div class="step-body">
        <div class="field"><label>Scope Items (3â€“5) â€” estimate minutes</label>
          <div class="scope-list" id="scopeList"></div>
          <button class="add-scope-btn" onclick="addScope()" id="addScopeBtn">+ Add item</button>
          <div class="time-summary" id="timeSummary"><span class="ts-label">Total:</span><span class="ts-value" id="totalTime">0 min</span></div>
        </div>
        <div class="field"><label>ğŸ”§ Approach â€” files/services I will touch</label><textarea id="approachField" placeholder="List specific files, services, configs you plan to modify..."></textarea></div>
        <div class="peer-section"><div class="field" style="margin-bottom:.5rem"><label>ğŸ‘¥ Who reviews this?</label><textarea class="short" id="peerWho" placeholder="Name/team..."></textarea></div><div class="field" style="margin:0"><label>What would SURPRISE them in your diff?</label><textarea class="short" id="peerSurprise" placeholder="Think from reviewer's perspective..."></textarea></div></div>
        <div class="field"><label>ğŸ…¿ Parking Lot</label><textarea id="parkingLot" placeholder="'While I'm in here...' ideas go HERE, not in your PR."></textarea></div>
        <div class="step-actions"><button class="btn btn-ghost" onclick="goBack(1)">â† Back</button><button class="btn btn-ghost" onclick="printPlan()">ğŸ–¨ï¸ Print Plan</button><button class="btn btn-primary" onclick="completeStep(2)" id="step2Btn">Start working â†’</button></div>
      </div>
    </div>
    <div class="step-connector"></div>

    <!-- STEP 3: EXECUTE -->
    <div class="step" id="step3">
      <div class="step-header" onclick="reopenStep(3)"><div class="step-number"><span>3</span></div><div class="step-title">Execute</div><div class="step-tag" style="background:var(--orange-dim);color:var(--orange)">do the work</div></div>
      <div class="step-body">
        <div class="diff-section"><h4>ğŸ“Š Diff Tracker â€” Planned vs Actual</h4><div id="diffList"></div>
          <div class="diff-add-extra"><input type="text" id="extraWorkInput" placeholder="Unplanned extra work..."><button class="btn btn-ghost btn-sm" onclick="addExtra()">+ Extra</button></div>
          <div class="amend-section" id="amendSection" style="display:none"><div class="field" style="margin:0"><label>ğŸ“‹ Scope Amendment â€” what and WHY?</label><textarea class="short" id="amendReason" placeholder="I need to add this because the original task is blocked without it..."></textarea></div><button class="btn btn-ghost btn-sm" style="margin-top:.3rem" onclick="submitAmendment()">Submit Amendment</button></div>
          <button class="btn btn-ghost btn-sm" style="margin-top:.4rem;border-color:var(--blue);color:var(--blue)" onclick="showAmendment()">ğŸ“‹ Scope Amendment</button>
        </div>
        <div class="step-actions"><button class="btn btn-ghost" onclick="pauseAndGoBack(2)">â† Review plan</button><button class="btn btn-primary" onclick="completeStep(3)" id="step3Btn">Done working â†’</button></div>
      </div>
    </div>
    <div class="step-connector"></div>

    <!-- STEP 4: PRE-PUSH CHECK -->
    <div class="step" id="step4">
      <div class="step-header" onclick="reopenStep(4)"><div class="step-number"><span>4</span></div><div class="step-title">Pre-Push Check</div><div class="step-tag" style="background:var(--green-dim);color:var(--green)">verify</div></div>
      <div class="step-body">
        <div id="checkQuestions"></div>
        <div class="step-actions"><button class="btn btn-ghost" onclick="goBack(3)">â† Back</button><button class="btn btn-primary" onclick="shipIt()" id="shipBtn" disabled>âœ“ Ship it!</button></div>
      </div>
    </div>
  </div>

  <!-- COMPLETION -->
  <div class="completion" id="completionSection">
    <div class="big-duck">ğŸ¦†</div>
    <h2>Shipped! ğŸ‰</h2>
    <div class="accuracy-card"><span class="acc-label">Accuracy</span><span class="acc-score" id="accScore">0%</span><span class="acc-detail" id="accDetail"></span></div>
    <p id="completionDuck"></p>
    <div class="completion-actions">
      <button class="btn btn-ghost" onclick="printFinal()">ğŸ–¨ï¸ Print Final</button>
      <button class="btn btn-ghost" onclick="exportMarkdown()">ğŸ“‹ Markdown</button>
      <button class="btn btn-primary" onclick="resetAll()">ğŸ¦† New Task</button>
    </div>
  </div>
</div>
<script type="module" src="./main.js"></script>
</body>
</html>
